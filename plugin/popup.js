var dpkiContract;
var web3Provider = null;
const nullAddress = "0x0000000000000000000000000000000000000000";

function init() {
  if (typeof web3 !== 'undefined' && typeof web3.currentProvider !== 'undefined') {
    web3Provider = web3.currentProvider;
    web3 = new Web3(web3Provider);
  } else {     
    web3Provider = new Web3.providers.HttpProvider("http://localhost:8545");
    web3 = new Web3(web3Provider);
  }

  
  initDPKIContract();
}


function initDPKIContract() {
  $.getJSON('DPKI.json', function(data) {
    // Get the necessary contract artifact file and instantiate it with truffle-contract
    dpkiContract = TruffleContract(data);

    // Set the provider for our contract
    dpkiContract.setProvider(web3Provider);

    // listen to the events emitted by our smart contract
    getEvents();

  });
}

function getEvents() {
  dpkiContract.deployed().then(function(instance) {
  var events = instance.allEvents(function(error, log){
    if (!error)
      $("#revokedCerts").prepend('<li>' + log.event + '</li>'); // Using JQuery, we will add new events to a list in our index.html
  });
  }).catch(function(err) {
    console.log(err.message);
  });
}

function registerAsSecondWrestler() {
  web3.eth.getAccounts(function(error, accounts) {
  if (error) {
    console.log(error);
  } else {
    if(accounts.length <= 0) {
      alert("No account is unlocked, please authorize an account on Metamask.")
    } else {
      WrestlingContract.deployed().then(function(instance) {
        return instance.registerAsAnOpponent({from: accounts[0]});
      }).then(function(result) {
        console.log('Registered as an opponent')
        getSecondWrestlerAddress();
      }).catch(function(err) {
        console.log(err.message);
      });
    }
  }
  });
}

$(function() {
  $(window).load(function() {
    init();
  });
});

document.addEventListener('DOMContentLoaded', function() {

  var checkPageButton = document.getElementById('checkPage');
  var x = document.getElementById("warning");
  checkPageButton.addEventListener('click', function() {
  	x.style.visibility = "visible";
  	  
      if (typeof web3 !== 'undefined') {
      	web3 = new Web3(web3.currentProvider);
        console.log("Web3 enabled")
        if(!web3.isConnected())
		    console.log("not connected");
		else
		    console.log("connected");

      var dpkiContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"signatureID","type":"uint256"}],"name":"revokeSignature","outputs":[{"name":"revocationID","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"attributeID","type":"uint256"},{"name":"expiry","type":"uint256"}],"name":"signAttribute","outputs":[{"name":"signatureID","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"signatures","outputs":[{"name":"signer","type":"address"},{"name":"attributeID","type":"uint256"},{"name":"expiry","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"attributeType","type":"string"},{"name":"has_proof","type":"bool"},{"name":"identifier","type":"bytes32"},{"name":"data","type":"string"},{"name":"datahash","type":"string"}],"name":"addAttribute","outputs":[{"name":"attributeID","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"attributes","outputs":[{"name":"owner","type":"address"},{"name":"attributeType","type":"string"},{"name":"has_proof","type":"bool"},{"name":"identifier","type":"bytes32"},{"name":"data","type":"string"},{"name":"datahash","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"revocations","outputs":[{"name":"signatureID","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"anonymous":false,"inputs":[{"indexed":true,"name":"attributeID","type":"uint256"},{"indexed":true,"name":"owner","type":"address"},{"indexed":false,"name":"attributeType","type":"string"},{"indexed":false,"name":"has_proof","type":"bool"},{"indexed":true,"name":"identifier","type":"bytes32"},{"indexed":false,"name":"data","type":"string"},{"indexed":false,"name":"datahash","type":"string"}],"name":"AttributeAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"signatureID","type":"uint256"},{"indexed":true,"name":"signer","type":"address"},{"indexed":true,"name":"attributeID","type":"uint256"},{"indexed":false,"name":"expiry","type":"uint256"}],"name":"AttributeSigned","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"revocationID","type":"uint256"},{"indexed":true,"name":"signatureID","type":"uint256"}],"name":"SignatureRevoked","type":"event"}]);
			var dpki = dpkiContract.new(
	   {
	     from: web3.eth.accounts[0], 
	     data: '0x608060405234801561001057600080fd5b50610e8f806100206000396000f300608060405260043610610078576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680633da1f79a1461007d57806363da9cf8146100be5780638be1019414610109578063b181954d14610184578063d05dcc6a146102a7578063ed0c804914610472575b600080fd5b34801561008957600080fd5b506100a8600480360381019080803590602001909291905050506104b3565b6040518082815260200191505060405180910390f35b3480156100ca57600080fd5b506100f36004803603810190808035906020019092919080359060200190929190505050610599565b6040518082815260200191505060405180910390f35b34801561011557600080fd5b506101346004803603810190808035906020019092919050505061067d565b604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001838152602001828152602001935050505060405180910390f35b34801561019057600080fd5b50610291600480360381019080803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192908035151590602001909291908035600019169060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506106d6565b6040518082815260200191505060405180910390f35b3480156102b357600080fd5b506102d26004803603810190808035906020019092919050505061096e565b604051808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001806020018615151515815260200185600019166000191681526020018060200180602001848103845289818151815260200191508051906020019080838360005b83811015610364578082015181840152602081019050610349565b50505050905090810190601f1680156103915780820380516001836020036101000a031916815260200191505b50848103835286818151815260200191508051906020019080838360005b838110156103ca5780820151818401526020810190506103af565b50505050905090810190601f1680156103f75780820380516001836020036101000a031916815260200191505b50848103825285818151815260200191508051906020019080838360005b83811015610430578082015181840152602081019050610415565b50505050905090810190601f16801561045d5780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390f35b34801561047e57600080fd5b5061049d60048036038101908080359060200190929190505050610bae565b6040518082815260200191505060405180910390f35b6000803373ffffffffffffffffffffffffffffffffffffffff166001848154811015156104dc57fe5b906000526020600020906003020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415610593576002805480919060010161053e9190610bd7565b915060028281548110151561054f57fe5b90600052602060002001905082816000018190555082827ff93d5095ac7696e643e1fa0aa35d622f4a13e11f4e199f30794679dcdcdb973760405160405180910390a35b50919050565b600080600180548091906001016105b09190610c03565b91506001828154811015156105c157fe5b90600052602060002090600302019050338160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550838160010181905550828160020181905550833373ffffffffffffffffffffffffffffffffffffffff16837f33a100675c6cfc265cebfab4d4b7a2f432674dd9f2b1f042546fad9dcaffe215866040518082815260200191505060405180910390a45092915050565b60018181548110151561068c57fe5b90600052602060002090600302016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010154908060020154905083565b600080600080548091906001016106ed9190610c35565b91506000828154811015156106fe57fe5b90600052602060002090600602019050338160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555086816001019080519060200190610769929190610c67565b50858160020160006101000a81548160ff02191690831515021790555084816003018160001916905550838160040190805190602001906107ab929190610c67565b50828160050190805190602001906107c4929190610c67565b5084600019163373ffffffffffffffffffffffffffffffffffffffff16837f047cf141cc7263346dbeabf372ff57a4a47ce442cbd821d9e8e7654bc78080d58a8a89896040518080602001851515151581526020018060200180602001848103845288818151815260200191508051906020019080838360005b8381101561085957808201518184015260208101905061083e565b50505050905090810190601f1680156108865780820380516001836020036101000a031916815260200191505b50848103835286818151815260200191508051906020019080838360005b838110156108bf5780820151818401526020810190506108a4565b50505050905090810190601f1680156108ec5780820380516001836020036101000a031916815260200191505b50848103825285818151815260200191508051906020019080838360005b8381101561092557808201518184015260208101905061090a565b50505050905090810190601f1680156109525780820380516001836020036101000a031916815260200191505b5097505050505050505060405180910390a45095945050505050565b60008181548110151561097d57fe5b90600052602060002090600602016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690806001018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a4f5780601f10610a2457610100808354040283529160200191610a4f565b820191906000526020600020905b815481529060010190602001808311610a3257829003601f168201915b5050505050908060020160009054906101000a900460ff1690806003015490806004018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b065780601f10610adb57610100808354040283529160200191610b06565b820191906000526020600020905b815481529060010190602001808311610ae957829003601f168201915b505050505090806005018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ba45780601f10610b7957610100808354040283529160200191610ba4565b820191906000526020600020905b815481529060010190602001808311610b8757829003601f168201915b5050505050905086565b600281815481101515610bbd57fe5b906000526020600020016000915090508060000154905081565b815481835581811115610bfe57818360005260206000209182019101610bfd9190610ce7565b5b505050565b815481835581811115610c3057600302816003028360005260206000209182019101610c2f9190610d0e565b5b505050565b815481835581811115610c6257600602816006028360005260206000209182019101610c619190610d64565b5b505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610ca857805160ff1916838001178555610cd6565b82800160010185558215610cd6579182015b82811115610cd5578251825591602001919060010190610cba565b5b509050610ce39190610df6565b5090565b610d0b91905b80821115610d075760008082016000905550600101610ced565b5090565b90565b610d6191905b80821115610d5d57600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556001820160009055600282016000905550600301610d14565b5090565b90565b610df391905b80821115610def57600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000610daa9190610e1b565b6002820160006101000a81549060ff02191690556003820160009055600482016000610dd69190610e1b565b600582016000610de69190610e1b565b50600601610d6a565b5090565b90565b610e1891905b80821115610e14576000816000905550600101610dfc565b5090565b90565b50805460018160011615610100020316600290046000825580601f10610e415750610e60565b601f016020900490600052602060002090810190610e5f9190610df6565b5b505600a165627a7a723058207550668a9904554dda3f1e8c1c22b1590c6f58829726717fc89bfd1c83c2db660029', 
	     gas: '4700000'
	   }, function (e, contract){
	    console.log(e, contract);
	    if (typeof contract.address !== 'undefined') {
	         console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
	    }
	 })

        } else {
            console.log("Web3 disabled")
        }
    
    	
  }, false);
}, false);
